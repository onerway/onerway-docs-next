---
title: Payment Status Updates
description: Monitor and verify payment status to respond to successful and failed payments.
draft: true
stripeDocUrl: https://docs.stripe.com/payments/payment-intents/verifying-status
---

# Payment Status Updates

## Monitor and verify payment status to respond to successful and failed payments.

# The Payment Intents API

## Learn how to use the Payment Intents API for Onerway payments.

Onerway 在收到订单后会为订单生成 transactionID，您的集成可通过检查 transactionID 来确定付款过程的状态，从而您可以对需要进一步干预的状态做出业务上的行动或响应。

## Check PaymentIntent Status on Client

用 [onPaymentCompleted](https://docs.onerway.com/apis/zh/v0.6/sdk-pay) 函数在客户端接收付款状态时，不能看作订单终态，因为该状态会因一些特殊场景出现错误。因此拿到状态后商家只需要向用户展示支付结果，不能用这个状态来更新商家系统的订单状态。

```javascript
onPaymentCompleted: function (res) {
  // 成功支付后回调方法
  const txtInfo = res.data // 返回交易结果详情
  const respCode = res.respCode // 响应码
  const respMsg = res.respMsg // 响应信息
  if (respCode === '20000') {
    // respCode 为 20000 表示交易正常
    switch (txtInfo.status) {
      case 'S': // status 为 'S' 表示成功
        break
      case 'R': // status 为 'R' 表示需要3ds验证
        // 当交易状态为 R 时，商户需要重定向到该URL完成部分交易，包括3ds验证
        window.location.href = txtInfo.redirectUrl
        break
    }
  } else {
    // 交易失败
  }
}
```

以下是使用 `onPaymentCompleted` 函数获取 status 的结果：

| status | 发生了什么 | 期望的集成 |
|--------|-----------|-----------|
| S | 客户在您的结账页面完成了付款，并且扣款成功 | 主动请求查询 API 获取订单终态，若仍为 S，则更新订单状态并通知用户付款成功 |
| F | 客户在您的结账页面完成了付款，但扣款失败 | 主动请求查询 API 获取订单终态，若为 F，则更新订单状态。并在服务端重新调用 API 创建 **Payment Intent** 刷新客户端的 transactionID 重新渲染收银台 |
| R | 客户在付款过程中触发了 3DS 挑战 | 将客户重定向到 3DS 挑战页面 |

## Check Order Status on Client Without onPaymentCompleted

若要在不使用 `onPaymentCompleted` 函数的情况下客户端检查订单状态，通常有两种方法：

### Method 1: API Response

使用 API 同步响应获取订单状态。当商户请求 Onerway [API Direct](https://docs.onerway.com/apis/zh/v0.6/api-card) 支付时，API 将在请求响应中直接返回支付结果，商户可从同步响应中获取订单状态（status）。商户可基于该状态立即更新订单或执行后续业务逻辑。

以下是使用 API 请求响应中会返回的支付状态：

| status | 发生了什么 | 期望的集成 |
|--------|-----------|-----------|
| S | 客户在您的结账页面完成了付款，并且扣款成功 | 通知客户他们付款成功了，并且更新订单状态。（此状态为订单终态） |
| F | 客户在您的结账页面完成了付款，但扣款失败 | 通知客户他们付款失败了，可以更新订单状态。并在服务端重新调用 API 创建 **Payment Intent** 刷新客户端的 transactionID 重新渲染收银台。（此状态为订单终态） |
| R | 客户在付款过程中触发了 3DS 挑战 | 将客户重定向到 3DS 挑战页面 |
| P | 支付处理中 | 通知客户支付处理中，可以通过查询 API 轮询我们的订单状态，直到获取到订单终态 S 或 F 并通知商户 |

### Method 2: Return URL

使用 [returnUrl](/get-started/start-building/about-the-apis/returnurl) 获取订单状态。当商户请求 Onerway API 时，会在请求中上送 returnUrl 字段并携带每笔订单的订单号。支付完成后，Onerway 会重定向回 returnUrl，并携带这个订单号。商户可以使用这个订单号轮询 Onerway 的 [Order Query API](https://docs.onerway.com/apis/zh/v0.6/order-query) 直到获得订单终态。

## Monitor transactionStatus with Webhooks

Onerway 可向您的服务器发送 Webhook 事件，在交易到达终态时通知您，您可以将它用于确定何时履行订单和服务等目的。

不要尝试在客户端处理订单履行操作，因为客户在付款完成后就可能离开页面，但这时还未来得及发起订单履行过程。相反，应该利用 Webhooks 来监测 `transactionStatus`，并异步处理订单履行，不要尝试在客户端发起履行过程。

::callout{type="warning" title="注意"}
从技术实现角度，可以通过轮询 [Order Query API](https://docs.onerway.com/apis/zh/v0.6/order-query) 获取订单状态，但这种单一方式可靠性较低：用户关闭页面会中断轮询，频繁请求可能触发 Onerway 的 API 限速机制，存在掉单风险。因此 Onerway 强烈建议采用 Webhook + 轮询的双保险方案，由 Webhook 负责实时推送订单状态，轮询作为补充机制定期检查遗漏订单，确保订单状态获取的完整性和可靠性。
::

::callout{type="warning" title="注意"}
要接收支付结果通知，请在发起支付请求时传入 `notifyUrl` 参数，用来创建 Webhook 地址。当订单状态变更为支付终态时，Onerway 会向该地址发送 Webhook 通知。
::

要[处理 Webhook 的签名](https://docs.onerway.com/apis/zh/v0.6/transaction-notification)：

::callout{type="danger" title="重要"}
请注意：`originTransactionId`、`originMerchantTxnId`、`customsDeclarationAmount`、`customsDeclarationCurrency`、`paymentMethod`、`walletTypeName`、`periodValue`、`tokenExpireTime`、`sign` 这些参数是固定不参与验签的。其余所有参数，包括未来 Onerway 在 Webhook 中新增的参数都是需要参与验签的。
::

### Handle Webhook Order Status

以下是使用 Webhook 接收 status 的结果：

| status | 发生了什么 | 期望的集成 |
|--------|-----------|-----------|
| S | 客户在您的结账页面完成了付款，并且扣款成功 | 通知客户他们付款成功了，并且更新订单状态 |
| F | 客户在您的结账页面完成了付款，但扣款失败 | 通知客户他们付款失败了，可以更新订单状态。并在服务端重新调用 API 创建 **Payment Intent** 刷新客户端的 transactionID 重新渲染收银台 |

## Handle Follow-up Actions

某些支付方式需要完成额外的步骤才能完成付款流程，例如 OXXO、Trustly 等都无法在短时间内获得支付结果。

通常情况下，API 请求响应中只有 `status: R`，商家需要将用户重定向到对应支付方式的页面。待用户完成付款后，对应支付方式大约需要几天时间来完成结账，Onerway 会配合处理这个过程，待拿到订单终态后，会以 Webhook 通知商家。

也就是说这类支付方式，商家只能选择等待 Webhook。因为即使通过轮询 Order Query API 短时间内也只能拿到 `status: P`，这不会有太多价值。

