---
title: 支付状态更新
description: 监控并验证支付状态，及时响应支付成功或失败。
---

客户在结账过程中的每个操作都会触发支付状态变化。通过检查支付状态，可以判断支付结果并执行相应的业务操作。

::note
支付结果必须以 webhook 通知为准。**切勿仅依赖同步响应中的 `status` 字段来确定最终状态。**
::

## 选择验证方式

| 方式 | 适用场景 | 可靠性 |
|------|----------|--------|
| [客户端回调](#在客户端检查支付状态) | 向用户展示即时反馈 | 低——不适合订单履约 |
| [API 响应](#使用-api-响应) | Direct API 集成 | 中——取决于客户端轮询 |
| [Return URL](#使用-return-url) | 重定向支付流程 | 中——需配合轮询 |
| [Webhook](#使用-webhook-监控支付状态) | 订单履约及后端处理 | 高——推荐方式 |

## 在客户端检查支付状态

通过 [onPaymentCompleted](#){badge="TODO"} 回调获取的 status 可用于向用户展示支付结果，但不应作为更新订单系统的依据。

```javascript
onPaymentCompleted: function (result) {
  const { respCode, respMsg, data: txnInfo } = result

  if (respCode === '20000') {
    switch (txnInfo.status) {
      case 'S':
        // Show success message to user
        // Query Order API for final confirmation before fulfillment
        break
      case 'R':
        // 3DS verification required
        window.location.href = txnInfo.redirectUrl
        break
      default:
        // Handle unexpected status
        break
    }
  } else {
    // Show error: respMsg contains the failure reason
    console.error('Payment failed:', respMsg)
  }
}
```

### 回调返回的状态

| 状态 | 含义 | 处理方式 |
|------|------|----------|
| `S` | 支付成功 | 调用[订单查询 API](#){badge="TODO"} 确认最终状态后，更新订单并通知客户。 |
| `F` | 支付失败 | 调用[订单查询 API](#){badge="TODO"} 确认最终状态后，创建新支付供客户重试。 |
| `R` | 需 3DS (3-D Secure) 验证 | 将客户重定向至 `txnInfo.redirectUrl` 完成 3DS 验证。 |

## 不使用回调检查状态

如果不使用 `onPaymentCompleted` 回调，可通过以下两种方式获取支付状态。

### 使用 API 响应

调用 [Direct API](#){badge="TODO"} 后，响应中直接包含支付状态，可据此更新订单或执行后续业务逻辑。

| 状态 | 含义 | 处理方式 |
|------|------|----------|
| `S` | 支付成功 | 更新订单并通知客户。此为最终状态。 |
| `F` | 支付失败 | 更新订单并通知客户，创建新支付供重试。此为最终状态。 |
| `R` | 需重定向 | 将客户重定向至返回的 URL（可能是 3DS 验证页或本地支付页面）。 |
| `P` | 处理中 | 告知客户支付正在处理，持续轮询[订单查询 API](#){badge="TODO"} 直至获取最终状态。 |

### 使用 return URL

调用 API 时传入 **`returnUrl`** 参数并携带订单标识。支付完成后，Onerway 会将客户重定向回该 URL 并附带订单标识，随后可通过[订单查询 API](#){badge="TODO"} 轮询最终状态。

了解更多：[配置 return URL](#){badge="TODO"}。

## 使用 webhook 监控支付状态

支付达到最终状态时，Onerway 会向服务器推送 webhook 事件。建议通过 webhook 处理订单履约，避免依赖客户端——客户可能在履约完成前离开页面。

接收 webhook 需在创建支付时传入 **`notifyUrl`** 参数。

::tip
推荐 webhook 与服务端轮询配合使用：webhook 提供实时通知，轮询作为兜底方案捕获遗漏的通知。避免客户端轮询——用户关闭页面会导致轮询中断。
::

### 处理 webhook 事件

Onerway 向 **`notifyUrl`** 发送 POST 请求，请求体为 JSON 格式：

```json
{
  "notifyType": "TXN",
  "transactionId": "1920061365985615872",
  "txnType": "SALE",
  "merchantNo": "800209",
  "merchantTxnId": "6a28ac11-d98c-4323-84a7-426b9322c4f7",
  "responseTime": "2025-05-07 18:21:21",
  "txnTime": "2025-05-07 18:21:17",
  "txnTimeZone": "+08:00",
  "orderAmount": "100.00",
  "orderCurrency": "USD",
  "status": "S",
  "cardBinCountry": "US",
  "reason": "{\"respCode\":\"20000\",\"respMsg\":\"Success\"}",
  "sign": "345f09b2240dcd2084605c28024b4d6fe7da4f84e59a7268b92bb66a36c433b3",
  "paymentMethod": "VISA"
}
```

| 状态 | 含义 | 处理方式 |
|------|------|----------|
| `S` | 支付成功 | 更新订单并通知客户。 |
| `F` | 支付失败 | 通知客户并创建新支付供重试。 |

### 响应 webhook

处理完成后，在响应体中返回 `transactionId` 的值即可，表示已成功接收通知。

::tip
Onerway 对失败的 webhook 最多重试 2 次，间隔 30 分钟。请确保接口具备**幂等性**——可通过 `transactionId` 去重。
::

完整的 webhook 参数说明和示例，请参阅[交易 Webhook 通知 API 参考](https://docs.onerway.com/apis/zh_cn/v0.6/transaction-notification){badge="API"}。

### 验证 webhook 签名

处理 webhook 时需验证签名，确保请求确实来自 Onerway。

::caution
以下参数不参与签名计算：`originTransactionId`、`originMerchantTxnId`、`customsDeclarationAmount`、`customsDeclarationCurrency`、`paymentMethod`、`walletTypeName`、`periodValue`、`tokenExpireTime`、`sign`。其余所有参数（包括未来新增的参数）均参与签名计算。
::

了解更多：[webhook 签名验证](#){badge="TODO"}。

## 处理延迟到账的支付方式

部分支付方式（如 :prose-annotation[OXXO]{annotation="墨西哥流行的现金支付方式"} 和 :prose-annotation[Trustly]{annotation="欧洲开放银行支付方式"}）无法即时返回结果，处理流程如下：

1. API 响应返回 `status: R`
2. 将用户重定向至对应支付页面
3. 用户完成支付（可能需要数天）
4. Onerway 在获取最终状态后发送 webhook 通知

::note
对于此类支付方式，**必须依赖 webhook 获取结果**。在支付完成前轮询[订单查询 API](#){badge="TODO"} 只会返回 `status: P`（处理中）。
::

::docs-resources
#title
## 另请参阅

#default
  :::docs-resource-item{to="https://docs.onerway.com/apis/zh_cn/v0.6/transaction-notification" title="交易 Webhook 通知" description="完整的 webhook 参数和 payload 示例" icon="i-lucide-webhook" tags="API"}
  :::

  :::docs-resource-item{to="https://docs.onerway.com/apis/zh_cn/v0.6/order-queries" title="订单查询 API" description="查询支付状态和订单详情" icon="i-lucide-search" tags="API"}
  :::
::
