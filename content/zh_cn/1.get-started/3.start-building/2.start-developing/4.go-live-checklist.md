---
title: 上线前检查清单
description: 使用此检查清单确保您的集成已准备好投入生产环境。
---

当您完成每个项目并勾选时，每个复选框的状态会存储在浏览器缓存中。您可以随时返回此页面查看已完成的内容。

Onerway 的沙盒环境和生产环境功能尽可能保持一致。在它们之间切换主要是替换您的 [API 密钥](#){badge="TODO"}。

如果您是开发人员（或有开发人员为您执行集成），在上线前还需考虑以下事项。如果您通过连接的网站或插件使用 Onerway，则大多数内容不适用。

## 检查清单

作为将集成上线的开发人员，请完成以下项目：

- [ ] 处理[边界情况](#){badge="TODO"}
- [ ] 检查您的 [API 错误处理](#){badge="TODO"}
- [ ] 检查您的[日志记录](#){badge="TODO"}
- [ ] 配置生产环境 webhook URL
- [ ] 更换并[保护您的 API 密钥](#){badge="TODO"}

## 处理边界情况

我们创建了多个[测试值](#){badge="TODO"}供您复现各种状态和响应。除了这些选项，请尽职尽责地测试您的集成，包括：

- 不完整数据（例如，缺少必填字段）
- 无效数据（例如，格式错误或超出范围的值）
- 重复数据（例如，重试同一请求以查看会发生什么）

我们还建议让其他人测试您的集成，尤其是非开发人员。

## 检查您的 API 错误处理

不要等到上线后才发现您没有正确编写代码来处理所有可能的[错误类型](#){badge="TODO"}，包括那些"永远不应该"发生的错误。确保您的代码具有防御性，不仅处理常见错误，还要处理所有可能性。

测试错误处理时，请密切关注向用户显示的信息。支付拒绝与验证错误或服务器错误是不同的问题。

| 错误类型   | 发生时机               | 向用户显示的内容   |
| ---------- | ---------------------- | ------------------ |
| 支付拒绝   | 余额不足、支付方式无效 | 支付相关的错误消息 |
| 验证错误   | 缺少必填字段、格式无效 | 字段相关的错误消息 |
| 服务器错误 | 超时、5xx 状态码       | 通用的"请重试"消息 |

::note
不要向用户暴露内部错误详情。每种错误类型都需要适当的消息以提供最佳用户体验。
::

## 检查您的日志记录

Onerway 会记录使用您 API 密钥的每个请求用于内部监控。我们建议您维护自己的日志，这对于调试和监控您的集成至关重要。您自己的日志在以下情况下可作为备份：服务器与 Onerway 通信时出现问题，或者 API 密钥出现问题——这两种情况都会阻止我们记录您的请求。

定期检查您的日志，确保它们仅存储所需的信息，而不包含任何敏感性质的内容（例如，信用卡详细信息或个人身份信息）。

### 应从日志中排除的内容

- **信用卡号**
- **个人身份信息 (PII)**
- **API 密钥和密钥**
- 调试不需要的内部系统详细信息

## 配置生产环境 webhook URL

创建支付请求时，您可以通过 `notifyUrl` 参数指定 webhook URL。请确保您的生产环境 webhook URL 配置正确，并且生产端点的功能与测试端点完全相同。

测试 webhooks 时，还要确保您的生产端点：

- 处理延迟的 webhook 通知
- 处理重复的 webhook 通知
- 不要求事件通知按特定顺序发生

### 处理延迟通知

Onerway 在支付事件发生时发送 webhook 通知。但是，由于网络问题、重试或高流量，通知可能会延迟。设计您的集成以优雅地处理迟到的通知。

如果 API 响应的支付结果表示最终状态，您可以更新商户订单状态。以下状态码表示最终状态：

| 状态 | 含义 |
| ---- | ---- |
| `S`  | 成功 |
| `F`  | 失败 |

如果通过 `returnUrl` 重定向返回，请调用 Onerway [查询 API](https://docs.onerway.com/apis/zh/v0.6/order-query){badge="API"} 查询订单的最终状态。

如果未查到结果，请使用以下轮询频率查询交易结果：

- 10 秒
- 30 秒
- 60 秒
- 5 分钟
- 10 分钟
- 30 分钟

### 处理重复通知

Webhook 端点有时可能会多次收到同一事件。您可以通过记录已处理的事件 ID 来防止重复的事件接收，然后不处理已记录的事件。

**示例模式**：

```javascript
// 跟踪已处理的事件
const processedEvents = new Set();

function handleWebhook(event) {
  // 检查是否已处理
  if (processedEvents.has(event.id)) {
    return; // 跳过重复
  }

  // 处理事件
  processEvent(event);

  // 标记为已处理
  processedEvents.add(event.id);
}
```

收到 webhook 通知后，将通知中的 `transactionId` 返回给 Onerway，以确认接收并防止重复投递。

## 后续步骤

完成此检查清单后，您就可以上线了。**恭喜**！以下是接下来要做的事情：

1. **更换您的 API 密钥** - 将测试 API 密钥替换为[正式 API 密钥](#){badge="TODO"}
2. **监控您的首批交易** - 在上线后的头几天定期检查您的日志，以便及早发现任何问题

::note
保留此检查清单以供将来参考，在启动新集成或更新现有集成时使用。
::
