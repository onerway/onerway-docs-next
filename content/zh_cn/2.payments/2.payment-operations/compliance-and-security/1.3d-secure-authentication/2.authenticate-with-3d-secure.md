---
title: 使用 3D Secure 进行认证
description: 将 3D Secure (3DS) 集成到支付流程中，增强支付安全性并实现责任转移。
---

将 3D Secure (3DS) 认证集成到多个平台的支付流程中，包括 Web、iOS、Android 和 React Native。当持卡人的发卡机构支持时，Onerway 会自动运行 3D Secure 2 (3DS2)，必要时回退到 3D Secure 1。

## 控制 3DS 流程

Onerway 在以下情况下自动触发 3DS：

- 法规强制要求（如欧洲的 [SCA](#){badge="TODO"}、英国的 PSD2）
- 行业指南要求（如日本的信用卡安全指南）
- 发卡机构通过[软拒绝](#){badge="TODO"}代码请求
- Onerway 的风险评估建议

你也可以使用 [API](#通过-api-手动请求-3ds) 决定何时提示用户进行 3DS 认证。这允许你根据业务需求自定义认证流程。但并非所有交易都支持 3DS，例如数字钱包支付或离线扣款。

当支付触发 3DS 时，发卡机构可能会要求客户进行认证（前提是卡支持 3DS）。虽然 Onerway 发起认证请求，但要求来自发卡机构。根据你的前端实现，可能需要[显示 3DS 流程](#3ds-流程)。

### 典型的 3DS 支付流程

在触发 3DS 的典型支付流程中：

1. 用户输入支付信息，商户通过[收银台支付 API](#){badge="TODO"} 提交订单请求，包括卡信息和订单详情。

2. Onerway 根据以下条件评估交易是否支持和需要 3DS：
  - 区域监管要求
  - 商户配置的风险规则
  - API 请求中的 3DS 参数设置
  - 发卡机构软拒绝响应
  - 交易风险等级评估

3. 如果 3DS：
  - **不需要**：例如因为豁免，Onerway 直接尝试扣款。订单转换为 `P`（处理中）状态。如果发卡机构返回需要 3DS 的软拒绝，系统会自动使用 3DS 重试。
  - **不支持**：Onerway 根据触发 3DS 的原因决定是否继续。如果允许，订单转换为 `P`（处理中）。如果不允许，转换为 `F`（失败）并返回错误信息。
  - **需要**：Onerway 通过联系发卡机构的 3DS Access Control Server (ACS) 启动 3DS 认证流程。订单转换为 `R`（待认证）。

4. 当从发卡机构收到 3DS 流程信息时，Onerway 提交请求让发卡机构对持卡人进行认证：
  - **Challenge 流程**：持卡人完成额外的认证步骤（如输入 OTP 或密码）。
  - **Frictionless 流程**：发卡机构在后台认证持卡人，无需额外输入。

::tip
Onerway 使用从多个来源推断的数据完成 3DS 请求——包括支付流程中收集的数据、历史交易记录以及来自卡或发卡机构的信息——以减少摩擦和认证失败。
::

5. 根据 3DS 认证结果：
  - **认证成功 (Y)**：Onerway 尝试扣款。如果成功，订单转换为 `S`（支付成功）。
  - **认证失败 (N)**：订单转换为 `F`（支付失败）。引导用户尝试其他支付方式，或通过创建新支付重试 3DS。

### 跟踪 3DS 认证

要跟踪卡支付是否支持并尝试了 3DS，请检查支付响应或订单查询 API 中返回的 `VerificationResult` 对象。当客户尝试 3DS 认证时，Onerway 会填充此字段：

| 字段     | 描述                                              |
| -------- | ------------------------------------------------- |
| 3DS 版本 | 使用的 3DS 协议版本（1.0 或 2.0）                 |
| 认证状态 | 认证的最终结果（Y 成功、N 失败、A 已尝试）        |
| ECI 值   | Electronic Commerce Indicator，指示交易的安全级别 |
| CAVV/XID | 认证验证值，证明已完成 3DS 认证                   |

## 通过 API 手动请求 3DS

触发 3DS 的默认方法是让 Onerway 根据风险等级和其他要求动态请求 3D Secure。手动触发 3DS 适用于将 Onerway 与自己的欺诈引擎集成的高级用户。

要手动触发 3DS，在调用收银台支付 API 时，在 `mpiInfo` 对象中设置 `risk3dsStrategy` 和相关参数：

```json
{
  "risk3dsStrategy": "EXTERNAL",
  "mpiInfo": "{\"eci\":\"05\",\"cavv\":\"AJkBBmUXZlVEZHlkdxdmAAAAAAA=\",\"dsTransID\":\"\",\"xid\":\"AJkBBmUXZlVEZHlkdxdmAAAAAAA=\"}"
}
```

何时提供此参数取决于你的欺诈引擎何时检测到风险：

- 如果你的欺诈引擎只检查卡详情，你在调用 API 之前就知道是否需要请求 3DS。
- 如果你的欺诈引擎同时检查卡和交易详情，在获得完整交易信息后提供该参数。

::note
Onerway 仅在卡支持 3DS 时才会提示客户进行认证。如果卡不支持 3DS 或认证过程中发生错误，支付将正常进行。
::

## 3DS 流程

调用收银台支付 API 后，Onerway 返回支付页面链接（`redirectUrl`）。将用户重定向到此页面以完成支付和认证。

Onerway 在 3DS2 认证期间收集基本的设备和交易信息，并将其发送给发卡机构进行风险分析。

### 重定向到 Onerway 收银台

调用收银台支付 API 时，在请求参数中传递 `notifyUrl`（异步通知 URL）和 `returnUrl`（同步重定向 URL）。

提交成功后，Onerway 返回 `redirectUrl`。将用户重定向到此地址以完成支付。如果交易需要 3DS 验证，用户在收银台页面内完成认证。验证后：

1. 用户被重定向回 `returnUrl`
2. Onerway 向 `notifyUrl` 发送异步支付结果通知

重定向会将 `orderNo`（商户订单号）作为查询参数附加到 `returnUrl`，你的应用程序可以使用它来识别和查询支付结果。

### 收银台页面显示

Onerway 收银台页面 UI 由 Onerway 控制。商户可以部分自定义字体、颜色和布局。3DS 验证界面由发卡机构控制，无法自定义。

你可以选择如何导航到收银台页面：

- **窗口重定向**：重定向当前窗口（最常见）
- **新标签页**：在新浏览器标签页中打开
- **iframe**：嵌入收银台页面（注意跨域和支付体验考虑）

### 发起支付请求

当客户准备完成购买时，调用 Onerway 收银台支付 API 创建支付会话：

```json
{
  "billingInformation": "{\"address\":\"71969 Cormier Mountain\",\"city\":\"Yakima\",\"country\":\"US\",\"email\":\"Watson91@gmail.com\",\"firstName\":\"Lyric\",\"lastName\":\"Morissette\",\"phone\":\"14848980027\",\"postalCode\":\"83406\",\"province\":\"CO\"}",
  "merchantCustId": "CustId-1F6O-9KB6",
  "merchantNo": "800209",
  "merchantTxnId": "e868e769-afe5-41f7-9882-04835122e0b3",
  "merchantTxnTime": "2025-04-18 14:47:42",
  "orderAmount": "3",
  "orderCurrency": "USD",
  "productType": "CARD",
  "subProductType": "DIRECT",
  "txnType": "SALE",
  "txnOrderMsg": "{\"returnUrl\":\"https://example.com/return\",\"notifyUrl\":\"https://example.com/webhook\"}"
}
```

要将订单信息附加到返回 URL：

```json
{
  "txnOrderMsg": "{\"returnUrl\":\"https://example.com/return?orderNo=2003042447256858624\"}"
}
```

### 检查订单状态

通过 [Webhook](#){badge="TODO"} 通知或查询[交易状态 API](#){badge="TODO"} 检查 `status` 字段，以确定支付是否成功完成：

| 状态 | 描述                                                            |
| ---- | --------------------------------------------------------------- |
| `S`  | 支付成功                                                        |
| `F`  | 支付失败                                                        |
| `P`  | 处理中——交易正在发卡机构和收单机构之间处理。等待 Webhook 通知。 |
| `R`  | 待认证——用户尚未完成支付或 3DS 验证                             |
| `U`  | 重定向到收银台——等待用户完成支付                                |
| `I`  | 退款已发起——等待退款审核                                        |

### 自动化 3DS 处理

Onerway 收银台自动处理 3DS 验证流程。商户无需在客户端检查状态或手动渲染 iframe。

自动化流程：

1. 用户在 Onerway 收银台填写卡信息并提交
2. Onerway 系统自动检测是否需要 3DS 验证
3. 如果需要，收银台显示 3DS 验证界面
4. 用户完成银行验证（输入 OTP、密码等）
5. 验证后，Onerway 处理支付结果
6. 用户被重定向到商户的 `returnUrl`
7. Onerway 向商户的 `notifyUrl` 发送 Webhook 通知

## 争议和责任转移

责任转移规则通常适用于使用 3DS 成功认证的支付。在某些情况下，责任转移适用于等效密文，如 Apple Pay 或 Google Pay。如果持卡人将 3DS 支付作为欺诈性交易提出争议，责任通常会从你转移到发卡机构。

如果卡不支持 3DS 或认证过程中发生错误，支付将正常进行。在这种情况下，责任通常不会转移到发卡机构，因为没有成功完成 3DS 认证。

实际上，这意味着如果支付被责任转移覆盖，你通常不会收到标记为欺诈的争议，但仍可能收到早期欺诈警告。

### 响应争议查询

你可能会收到关于成功认证的 3DS 支付的争议查询。这类争议不会导致拒付，因为它只是信息请求。

::caution
如果你收到关于 3D Secure 认证支付的查询，**必须**响应。如果不响应，持卡人的银行可以发起"无回复"拒付，使责任转移失效。
::

要防止无回复拒付，请提交关于该笔扣款的充分信息：

- 订购了什么
- 如何交付
- 交付给谁（实物商品、电子商品或服务）

::note
如果客户因其他原因（如未收到产品）对支付提出争议，则适用标准争议程序。
::

### 责任转移适用的情况

当卡组织要求 3DS 但卡或发卡机构不可用时，也可能发生责任转移。这可能发生在：

- 发卡机构的 3DS 提供商宕机
- 发卡机构不支持 3DS（尽管卡组织要求）

在支付过程中，持卡人不会被提示完成 3DS 认证，因为卡未注册。尽管持卡人没有完成认证，责任仍可能转移到发卡机构。

Onerway 在 3DS 验证结果的 `electronic_commerce_indicator` 字段中返回请求的 ECI 值。此指示符有助于确定扣款是否应遵循责任转移规则。由于 3DS 发生在初始支付响应之后，你通常从 Webhook 或查询 API 结果中获取此信息。

### 责任转移不适用的情况

::warning
有时使用 3DS 成功认证的支付不属于责任转移。这种情况很少见，但可能发生在：

- 你的账户存在过高的欺诈水平并已加入欺诈监控计划
- 卡组织已将你的行业排除在责任转移之外（例如，Visa 不支持电汇、汇票、外币服务或储值卡购买的责任转移）
- 责任转移在授权后被降级
- 卡组织的争议拒绝系统未能识别交易的责任转移

如果你对争议提出异议，Onerway 会自动将请求的 ECI 和 3DS 认证结果添加到你的证据详情中。我们建议提供额外详情以增加胜诉机会。
::
