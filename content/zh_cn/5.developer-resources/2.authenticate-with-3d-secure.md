---
title: 使用 3D Secure 进行身份验证
description: 将 3D Secure (3DS) 集成到结账流程中，增强支付安全性并实现责任转移。
---

将 3D Secure（3DS，3D 安全验证）身份验证集成到结账流程中，支持 Web、iOS、Android 和 React Native 等多个平台。当持卡人的发卡行支持时，Onerway 会自动运行 3D Secure 2（3DS2），否则回退到 3D Secure 1。

## 控制 3DS 流程

Onerway 在以下情况自动触发 3DS：

- 法规强制要求（如欧洲的 [SCA（强客户认证）](#){badge="TODO"}、英国的 PSD2（第二支付服务指令））
- 行业指南要求（如日本的信用卡安全指南）
- 发卡行通过[软拒绝](#){badge="TODO"}代码请求
- Onerway 风控评估建议

也可通过 [API](#通过-api-手动请求-3ds) 决定何时提示用户进行 3DS 身份验证，根据业务需求自定义验证流程。但并非所有交易都支持 3DS，例如数字钱包支付或离线扣款。

当支付触发 3DS 时，只要卡片支持 3DS，发卡行可能要求客户进行身份验证。虽然 Onerway 发起验证请求，但要求来自发卡行。根据前端实现，可能需要[显示 3DS 流程](#3ds-流程)。

### 典型的 3DS 支付流程

在触发 3DS 的典型收银台支付流程中：

1. 用户输入支付信息，商户通过[收银台支付 API](#){badge="TODO"} 提交订单请求，包含卡片信息和订单详情。

2. Onerway 根据以下因素评估交易是否支持和需要 3DS：
  - 地区法规要求
  - 商户配置的风控规则
  - API 请求中的 3DS 参数设置
  - 发卡行软拒绝响应
  - 交易风险等级评估

3. 如果 3DS：
  - **不需要**：例如符合豁免条件，Onerway 直接尝试扣款。订单状态转为 `P`（处理中）。如果发卡行返回软拒绝要求 3DS，系统自动重试并启动 3DS。
  - **不支持**：Onerway 根据触发 3DS 的原因决定是否继续。如果允许，订单状态转为 `P`（处理中）；如果不允许，转为 `F`（失败）并返回错误信息。
  - **需要**：Onerway 联系发卡行的 3DS 访问控制服务器（ACS）启动 3DS 身份验证流程。订单状态转为 `R`（待验证）。

4. 收到发卡行的 3DS 流程信息后，Onerway 提交请求让发卡行验证持卡人身份：
  - **挑战流程**：持卡人完成额外的身份验证步骤（如输入 OTP 或密码）。
  - **无摩擦流程**：发卡行在后台自动验证持卡人，无需额外操作。

::tip
Onerway 使用多来源推断的数据完成 3DS 请求——包括支付流程中收集的数据、历史交易记录以及卡片或发卡行信息——以减少摩擦和验证失败。
::

5. 根据 3DS 验证结果：
  - **验证成功（Y）**：Onerway 尝试扣款。如果成功，订单状态转为 `S`（支付成功）。
  - **验证失败（N）**：订单状态转为 `F`（支付失败）。引导用户尝试其他支付方式，或创建新支付重试 3DS。

### 追踪 3DS 验证

要追踪卡支付是否支持和尝试了 3DS，检查支付响应或订单查询 API 返回的 `VerificationResult` 对象。当客户尝试 3DS 验证时，Onerway 填充此字段：

| 字段 | 说明 |
|------|------|
| `threeDSVersion` | 使用的 3DS 协议版本（1.0 或 2.0） |
| `authenticationStatus` | 验证最终结果（Y 成功、N 失败、A 已尝试） |
| `eci` | 电子商务指示符，表示交易的安全级别 |
| `cavv` / `xid` | 验证值，证明已完成 3DS 验证 |

## 通过 API 手动请求 3DS

默认情况下，Onerway 根据风险级别和其他要求动态请求 3D Secure。手动触发 3DS 适用于将 Onerway 与自有反欺诈引擎集成的高级用户。

手动触发 3DS 时，在调用收银台支付 API 时设置 `risk3dsStrategy` 和 `mpiInfo` 对象中的相关参数：

```json
{
  "risk3dsStrategy": "EXTERNAL",
  "mpiInfo": "{\"eci\":\"05\",\"cavv\":\"AJkBBmUXZlVEZHlkdxdmAAAAAAA=\",\"dsTransID\":\"\",\"xid\":\"AJkBBmUXZlVEZHlkdxdmAAAAAAA=\"}"
}
```

何时提供此参数取决于反欺诈引擎何时检测到风险：

- 如果反欺诈引擎仅检查卡片详情，可在调用 API 前确定是否请求 3DS。
- 如果反欺诈引擎同时检查卡片和交易详情，在获得完整交易信息后再提供参数。

::note
Onerway 仅在卡片支持 3DS 时提示客户进行身份验证。如果卡片不支持 3DS 或验证过程中发生错误，支付将正常进行。
::

## 3DS 流程

调用收银台支付 API 后，Onerway 返回支付页面链接（`redirectUrl`）。将用户重定向到此页面完成支付和身份验证。

Onerway 在 3DS2 验证期间收集基本设备和交易信息，并发送给发卡行进行风险分析。

### 重定向到 Onerway 收银台

调用收银台支付 API 时，在请求参数中传递 `notifyUrl`（异步通知 URL）和 `returnUrl`（同步重定向 URL）。

提交成功后，Onerway 返回 `redirectUrl`。将用户重定向到此地址完成支付。如果交易需要 3DS 验证，用户在收银台页面内完成身份验证。验证后：

1. 用户被重定向回 `returnUrl`
2. Onerway 向 `notifyUrl` 发送异步支付结果通知

重定向会将 `orderNo`（商户订单号）作为查询参数附加到 `returnUrl`，应用可用于识别和查询支付结果。

### 收银台页面显示

Onerway 收银台页面的 UI 由 Onerway 控制。商户可部分自定义字体、颜色和布局。3DS 验证界面由发卡行控制，无法自定义。

导航到收银台页面的方式：

- **窗口重定向**：重定向当前窗口（最常见）
- **新标签页**：在新浏览器标签页中打开
- **iframe**：嵌入收银台页面（注意跨域和支付体验问题）

### 发起支付请求

当客户准备完成购买时，调用 Onerway 收银台支付 API 创建支付会话：

```json
{
  "billingInformation": "{\"address\":\"71969 Cormier Mountain\",\"city\":\"Yakima\",\"country\":\"US\",\"email\":\"Watson91@gmail.com\",\"firstName\":\"Lyric\",\"lastName\":\"Morissette\",\"phone\":\"14848980027\",\"postalCode\":\"83406\",\"province\":\"CO\"}",
  "merchantCustId": "CustId-1F6O-9KB6",
  "merchantNo": "800209",
  "merchantTxnId": "e868e769-afe5-41f7-9882-04835122e0b3",
  "merchantTxnTime": "2025-04-18 14:47:42",
  "orderAmount": "3",
  "orderCurrency": "USD",
  "productType": "CARD",
  "subProductType": "DIRECT",
  "txnType": "SALE",
  "txnOrderMsg": "{\"returnUrl\":\"https://example.com/return\",\"notifyUrl\":\"https://example.com/webhook\"}"
}
```

将订单信息附加到返回 URL：

```json
{
  "txnOrderMsg": "{\"returnUrl\":\"https://example.com/return?orderNo=2003042447256858624\"}"
}
```

### 检查订单状态

通过 [webhook](#){badge="TODO"} 通知或查询[交易状态 API](#){badge="TODO"} 检查 `status` 字段，确定支付是否成功完成：

| 状态 | 说明 |
|------|------|
| `S` | 支付成功 |
| `F` | 支付失败 |
| `P` | 处理中——交易正在发卡行和收单行之间处理，等待 webhook 通知 |
| `R` | 待验证——用户尚未完成支付或 3DS 验证 |
| `U` | 重定向到收银台——等待用户完成支付 |
| `I` | 退款已发起——等待退款审核 |

### 自动化 3DS 处理

Onerway 收银台自动处理 3DS 验证流程。商户无需在客户端检查状态或手动渲染 iframe。

自动化流程：

1. 用户在 Onerway 收银台填写卡片信息并提交
2. Onerway 系统自动检测是否需要 3DS 验证
3. 如果需要，收银台显示 3DS 验证界面
4. 用户完成银行验证（输入 OTP、密码等）
5. 验证完成后，Onerway 处理支付结果
6. 用户被重定向到商户的 `returnUrl`
7. Onerway 向商户的 `notifyUrl` 发送 webhook 通知

## 争议与责任转移

责任转移规则通常适用于成功通过 3DS 验证的支付。某些情况下，责任转移也适用于等效的加密凭证，如 Apple Pay 或 Google Pay。如果持卡人对 3DS 支付提出欺诈争议，责任通常从商户转移到发卡行。

如果卡片不支持 3DS 或验证过程中发生错误，支付将正常进行。此时，由于未成功完成 3DS 验证，责任通常不会转移到发卡行。

实际上，如果支付受责任转移保护，通常不会收到标记为欺诈的争议，但可能仍会收到早期欺诈预警。

### 响应争议查询

可能会收到成功通过 3DS 验证的支付的争议查询。此类争议不会导致拒付，因为只是信息请求。

::caution
如果收到 3D Secure 验证交易的查询，**必须**响应。如果不响应，持卡人银行可发起"无回复"拒付，使责任转移失效。
::

为防止无回复拒付，提交足够的交易信息：

- 订购内容
- 配送方式
- 收货人（实物商品、电子商品或服务）

::note
如果客户因其他原因（如未收到商品）对支付提出争议，适用标准争议处理流程。
::

### 责任转移适用情况

当卡组织要求 3DS 但卡片或发卡行无法提供时，也可能发生责任转移。这可能发生在：

- 发卡行的 3DS 服务提供商宕机
- 发卡行不支持 3DS，尽管卡组织要求支持

支付过程中，由于卡片未注册，不会提示持卡人完成 3DS 验证。尽管持卡人未完成验证，责任仍可转移到发卡行。

Onerway 在 3DS 验证结果的 `electronic_commerce_indicator` 字段中返回请求的 ECI 值。此指标有助于确定扣款是否应遵循责任转移规则。由于 3DS 发生在初始支付响应之后，通常从 webhook 或查询 API 结果获取此信息。

### 责任转移不适用情况

::warning
有时成功通过 3DS 验证的支付不属于责任转移范围。这种情况罕见，但可能发生在：

- 账户欺诈率过高，已加入欺诈监控计划
- 卡组织已豁免所在行业的责任转移（例如，Visa 不支持电汇、汇票、外币服务或储值卡购买的责任转移）
- 授权后责任转移被降级
- 卡组织的争议拒绝系统未能识别交易的责任转移

如果对争议提出抗辩，Onerway 自动将请求的 ECI 和 3DS 验证结果添加到证据详情中。建议提供额外细节以提高胜诉几率。
::
